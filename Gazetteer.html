<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <title>Gazetter</title>
    <style>
        * {
            margin: 5px;
        }

        div {
            width: 150px;
            margin-left: 15px;
        }

        select {
            width: 150px;
            align-items: center;
        }
    </style>
    <script
            src="https://code.jquery.com/jquery-3.4.1.min.js"
            integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
            crossorigin="anonymous"
    ></script>
</head>
<body>
<div id="choices" style="display: block">
    <h3>COUNTRY</h3>
    <select id="l0" class="test" onchange="changeStructure(); query(this)"></select>
</div>
</body>
<script>
    const apikey = '--apikey--';
    let depth = 0;
    let queryLevel = 0;
    let divSelect = $('#choices');

    //Populates the first list with options, gets currently supported countries
    $(document).ready(() => {
        $.getJSON('https://gdh-api.reach-u.com/gz/levels?apikey=' + apikey, result => {
            $.each(result, (i, field) => {
                $('#l0').append(
                    $('<option>', {
                        text: field,
                        id: i,
                    })
                );
            });
        });
    });

    //Since each country has different administrative divisions, the structure needs to be changed based on the country
    const changeStructure = () => {
        depth = 0;
        divSelect.find('h4').remove();
        divSelect.find('.deafult').remove();
        let cc = $('#l0')
            .children(':selected')
            .attr('id');
        $(this)
            .parent('div.order_number')
            .remove();
        $.getJSON('https://gdh-api.reach-u.com/gz/levels/' + cc + '?apikey=' + apikey, result => {
            $.each(result, (i, field) => {
                depth++;
                i = 'l' + i.substr(-1);
                if (i !== 'l0') {
                    divSelect.append(
                        $('<h4>', {
                            text: field,
                        })
                    );
                    divSelect.append(
                        $('<select>', {
                            class: 'test deafult',
                            id: i,
                            onChange: 'query(this)',
                            disabled: true,
                        })
                    );
                }
            });
        });
    };

    const query = val => {
        let selectValues = [];
        divSelect.find('.test').each(function () {
            if ($(this).val() != null) {
                selectValues.push(this.id + '=' + $(this).val());
                if (this.id === val.id) {
                    return false;
                }
            }
        });
        let param = selectValues.join('&');
        queryLevel = parseInt(selectValues.pop().substr(1, 1)) + 1;
        responseHandler(param, queryLevel);
    };

    const responseHandler = (queryParam, level) => {
        //get json based on query
        $.getJSON(
            'https://gdh-api.reach-u.com/gz/' + level + '?' + queryParam + '&apikey=' + apikey,
            result => {
                //if response is empty check if other levels have responses
                if (result.length === 0 && level < depth) {
                    responseHandler(queryParam, level + 1);
                } else if (level < depth) {
                    //remove elements that are after the selected box
                    for (let i = queryLevel; i < depth; i++) {
                        $('#l' + i)
                            .empty()
                            .attr('disabled', true);
                    }

                    let levels = '#l' + level;
                    //add response to the element
                    $(levels).append(
                        $('<option>', {
                            text: '--select--',
                            selected: 'selected',
                            disabled: true,
                            value: '',
                        })
                    );

                    result.forEach(element => {
                        $(levels).append(
                            $('<option>', {
                                text: element.value,
                            })
                        );
                    });
                    $(levels).prop('disabled', false);
                    if (result.length === 2) {
                        query($(levels));
                    }
                }
            }
        );
    };
</script>
</html>
